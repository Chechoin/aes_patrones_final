services:
  db:
    image: postgres:13
    container_name: postgres_db
    env_file:
      - .env
    volumes:
      - ./volumes/postgresql_data:/var/lib/postgresql/data/
    ports:
      - 5432:5432
    networks:
      - exam

  payments_manager:
    build: 
      context: payments_manager
      dockerfile: Dockerfile
    ports:
      - "8010:8010"
      # - "8888:8888"
    volumes:
      - ./payments_manager:/app/payments_manager
    env_file:
      - .env
    command: ["uvicorn", "clients_microservice.main:app", "--host", "0.0.0.0", "--port", "8010", "--reload"]
    depends_on:
      - db
    networks:
      - exam

  #transactions_manager:
  #  build: 
  #    context: transactions_manager
  #    dockerfile: Dockerfile
  #  ports:
  #    - "8010:8010"
  #    # - "8888:8888"
  #  volumes:
  #    - ./transactions_manager:/app/transactions_manager
  #  env_file:
  #    - .env
  #  command: ["uvicorn", "clients_microservice.main:app", "--host", "0.0.0.0", "--port", "8010", "--reload"]
  #  # command: ["python","-m","debugpy","--listen","0.0.0.0:8888","--wait-for-client","-m","uvicorn","transactions_manager.main:app","--host","0.0.0.0","--port","8013","--reload"] # debugpy
  #  depends_on:
  #    - db
  #  networks:
  #    - exam

  accounts_microservice:
    build: 
      context: accounts_microservice
      dockerfile: Dockerfile
    ports:
      - "8013:8013"
      # - "8888:8888"
    volumes:
      - ./accounts_microservice:/app/accounts_microservice
    env_file:
      - .env
    command: ["uvicorn", "accounts_microservice.main:app", "--host", "0.0.0.0", "--port", "8013", "--reload"]
    # command: ["python","-m","debugpy","--listen","0.0.0.0:8888","--wait-for-client","-m","uvicorn","accounts_microservice.main:app","--host","0.0.0.0","--port","8013","--reload"] # debugpy
    depends_on:
      - db
      - rabbitmq
    networks:
      - exam

  clients_microservice:
    build: 
      context: clients_microservice
      dockerfile: Dockerfile
    ports:
      - "8012:8012"
      # - "8888:8888"
    volumes:
      - ./clients_microservice:/app/clients_microservice
    env_file:
      - .env
    # command: ["python","-m","debugpy","--listen","0.0.0.0:8888","--wait-for-client","-m","uvicorn","clients_microservice.main:app","--host","0.0.0.0","--port","8012","--reload"] # debugpy
    command: ["uvicorn", "clients_microservice.main:app", "--host", "0.0.0.0", "--port", "8012", "--reload"]
    depends_on:
      - db
    networks:
      - exam

  rabbitmq:
    image: rabbitmq:3.9.29-management-alpine
    container_name: rabbitmq
    #ports:
    #    - '15672:15672'
    volumes:
      - ./volumes/rabbitmq/data:/var/lib/rabbitmq/data
      - ./volumes/rabbitmq/log:/var/log/rabbitmq/
    # logging:
    #   driver: none
    networks:
      - exam

networks:
  exam:
    driver: bridge
    #external: true